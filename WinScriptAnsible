Скрипт для настройки виндовс хоста для Ansible
# Setup-Ansible-Target.ps1 - Автоматическая настройка Windows для Ansible

Write-Host "=== Настройка Windows для Ansible ===" -ForegroundColor Cyan

# 1. Создание пользователя для Ansible
Write-Host "`n1. Создание пользователя Ansible..." -ForegroundColor Yellow
$username = "User"
$password = "password"

# Проверяем существование пользователя
$userExists = Get-LocalUser -Name $username -ErrorAction SilentlyContinue
if (-not $userExists) {
    # Создаем пользователя
    $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
    New-LocalUser -Name $username -Password $securePassword -FullName "Ansible Control User" -Description "User for Ansible automation"
    Write-Host "Пользователь $username создан" -ForegroundColor Green
} else {
    Write-Host "Пользователь $username уже существует" -ForegroundColor Yellow
}

# Добавляем в группу администраторов
Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue
Write-Host "Пользователь добавлен в группу Administrators" -ForegroundColor Green

# 2. Настройка сетевого профиля
Write-Host "`n2. Настройка сетевого профиля..." -ForegroundColor Yellow

# Получаем все сетевые профили
$profiles = Get-NetConnectionProfile

foreach ($profile in $profiles) {
    Write-Host "Меняем профиль сети $($profile.Name) на Private (InterfaceIndex: $($profile.InterfaceIndex))" -ForegroundColor White
    Set-NetConnectionProfile -InterfaceIndex $profile.InterfaceIndex -NetworkCategory Private
}

# Установка постоянного Private профиля для Ethernet
$ethernetProfile = Get-NetConnectionProfile -InterfaceAlias "Ethernet" -ErrorAction SilentlyContinue
if ($ethernetProfile) {
    Set-NetConnectionProfile -InputObject $ethernetProfile -NetworkCategory Private
    Write-Host "Ethernet профиль установлен как Permanent Private" -ForegroundColor Green
}

# 3. Установка и настройка WinRM
Write-Host "`n3. Установка и настройка WinRM..." -ForegroundColor Yellow

# Проверяем установлен ли WinRM
$winrmService = Get-Service WinRM -ErrorAction SilentlyContinue

if (-not $winrmService) {
    Write-Host "WinRM не установлен. Устанавливаем..." -ForegroundColor Yellow
    # Включаем WinRM через DISM (для Windows)
    Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-SMBServer -All -NoRestart
    Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-SMBDirect -All -NoRestart
}

# Быстрая конфигурация WinRM
Write-Host "Настройка WinRM..." -ForegroundColor White
winrm quickconfig -quiet -force

# Включение Basic аутентификации и незашифрованного трафика
Write-Host "Включение Basic аутентификации..." -ForegroundColor White
winrm set winrm/config/service '@{AllowUnencrypted="true"}'
winrm set winrm/config/service/auth '@{Basic="true"}'

# Добавление подсети в доверенные хосты
Write-Host "Добавление доверенных хостов..." -ForegroundColor White
winrm set winrm/config/client '@{TrustedHosts="[x.x.x.x"}'

# 4. Открытие портов в фаерволе
Write-Host "`n4. Настройка фаервола..." -ForegroundColor Yellow

# Проверяем существование правил
$httpRule = Get-NetFirewallRule -DisplayName "Allow WinRM HTTP" -ErrorAction SilentlyContinue
$httpsRule = Get-NetFirewallRule -DisplayName "Allow WinRM HTTPS" -ErrorAction SilentlyContinue

if (-not $httpRule) {
    New-NetFirewallRule -DisplayName "Allow WinRM HTTP" -Direction Inbound -LocalPort 5985 -Protocol TCP -Action Allow
    Write-Host "Правило для WinRM HTTP (5985) создано" -ForegroundColor Green
} else {
    Write-Host "Правило для WinRM HTTP уже существует" -ForegroundColor Yellow
}

if (-not $httpsRule) {
    New-NetFirewallRule -DisplayName "Allow WinRM HTTPS" -Direction Inbound -LocalPort 5986 -Protocol TCP -Action Allow
    Write-Host "Правило для WinRM HTTPS (5986) создано" -ForegroundColor Green
} else {
    Write-Host "Правило для WinRM HTTPS уже существует" -ForegroundColor Yellow
}

# 5. Перезапуск WinRM
Write-Host "`n5. Перезапуск WinRM..." -ForegroundColor Yellow
Restart-Service WinRM -Force
Write-Host "Служба WinRM перезапущена" -ForegroundColor Green

# 6. Установка Chocolatey (опционально)
Write-Host "`n6. Установка Chocolatey..." -ForegroundColor Yellow
$chocoCheck = Get-Command choco -ErrorAction SilentlyContinue
if (-not $chocoCheck) {
    try {
        Set-ExecutionPolicy Bypass -Scope Process -Force
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
        iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
        Write-Host "Chocolatey установлен" -ForegroundColor Green
    } catch {
        Write-Host "Ошибка установки Chocolatey: $_" -ForegroundColor Red
    }
} else {
    Write-Host "Chocolatey уже установлен" -ForegroundColor Yellow
}

# 7. Дополнительные настройки для надежности
Write-Host "`n7. Дополнительные настройки..." -ForegroundColor Yellow

# Настройка службы WinRM для автоматического запуска
Set-Service WinRM -StartupType Automatic
Write-Host "WinRM настроен на автоматический запуск" -ForegroundColor Green

# Проверяем что WinRM слушает нужные порты
$listeners = winrm e winrm/config/listener
Write-Host "Конфигурация listeners WinRM:" -ForegroundColor White
$listeners

# 8. Проверка настроек
Write-Host "`n8. Проверка настроек..." -ForegroundColor Yellow

Write-Host "Сетевые профили:" -ForegroundColor White
Get-NetConnectionProfile | Format-Table InterfaceIndex, Name, NetworkCategory

Write-Host "Статус WinRM:" -ForegroundColor White
Get-Service WinRM | Format-Table Name, Status, StartType

Write-Host "Правила фаервола:" -ForegroundColor White
Get-NetFirewallRule -DisplayName "Allow WinRM*" | Format-Table DisplayName, Enabled, Direction, Action

Write-Host "Созданные пользователи:" -ForegroundColor White
Get-LocalUser -Name $username | Format-Table Name, Enabled, Description

Write-Host "`n=== Настройка завершена! ===" -ForegroundColor Cyan
Write-Host "Для тестирования подключения с Ansible-хоста выполните:" -ForegroundColor White
Write-Host "ansible -i inventory windows -m win_ping" -ForegroundColor Green
Write-Host "Учетные данные: $username / $password" -ForegroundColor Yellow

# Пауза для просмотра результатов
Write-Host "`nНажмите любую клавишу для выхода..." -ForegroundColor Gray
$null = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown")
