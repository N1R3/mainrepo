Описание UserParameters для zabbix на Linux серверах
Файлы с настроенными юзер параметрами лежат тут etc/zabbix/zabbix_agent2.d называются diskstats.conf и ifstatus.conf

Для начало опишем мониторинг дисков

Данные пользовательские параметры используются для мониторинга производительности дисковой подсистемы Linux через чтение файла /proc/diskstats. Они позволяют отслеживать количество операций и среднее время ожидания операций ввода-вывода (чтения и записи). Описание каждого параметра:

1. custom.disk.read.await[*] Синтаксис:

UserParameter=custom.disk.read.await[*],awk '$$3=="$1"{if($$4>0) print ($$7/$$4); else print 0}' /proc/diskstats
Что делает: - Ищет в файле /proc/diskstats строку, где третий столбец ($3) соответствует имени диска, который передается как аргумент ($1). - Считает среднее время ожидания операции чтения. Для этого берет значение поля $7 (суммарное время ожидания операций чтения в миллисекундах) и делит на $4 (количество операций чтения). - Если количество операций чтения равно нулю, возвращает 0. Таким образом, данный параметр возвращает среднее время ожидания одной операции чтения в миллисекундах.

2. custom.disk.write.await[*] Синтаксис:

UserParameter=custom.disk.write.await[*],awk '$$3=="$1"{if($$8>0) print ($$11/$$8); else print 0}' /proc/diskstats
Что делает: - Аналогично предыдущему параметру, но считает среднее время ожидания операций записи. - Делит суммарное время ожидания записи ($11) на количество операций записи ($8). - Если количество операций записи равно нулю, возвращает 0. Таким образом, параметр возвращает среднее время ожидания одной операции записи в миллисекундах. 
3. custom.disk.read.ops[*] Синтаксис:

UserParameter=custom.disk.read.ops[*],awk '$$3=="$1"{print $$4}' /proc/diskstats
 Что делает: - Возвращает общее количество операций чтения с момента загрузки системы для указанного диска (поле $4 в файле /proc/diskstats). 

4. custom.disk.write.ops[*] Синтаксис:
UserParameter=custom.disk.write.ops[*], awk '$$3=="$1"{print $$8}' /proc/diskstats
Что делает: - Возвращает общее количество операций записи с момента загрузки системы для указанного диска (поле $8 в файле /proc/diskstats).

После настройки можно проверить что параметры корректно выводятся:

zabbix_agent2 -t custom.disk.read.await[sda]
zabbix_agent2 -t custom.disk.write.await[sda]
zabbix_agent2 -t custom.disk.read.ops[sda]
zabbix_agent2 -t custom.disk.write.ops[sda]

Взаимодействие UserParameter с итемами (Items): В Zabbix данные пользовательские параметры используются в элементах данных (Items) следующим образом: - Item "Disk {$DISK_MONITOR} read await" использует параметр:

custom.disk.read.await[{$DISK_MONITOR}]
 Т.е. макрос {$DISK_MONITOR} задает имя диска, который мониторится этим элементом. - Item "Disk {$DISK_MONITOR1} read ops" использует параметр:

custom.disk.read.ops[{$DISK_MONITOR1}]
- Item "Disk {$DISK_MONITOR2} write await" использует параметр:

custom.disk.write.await[{$DISK_MONITOR2}]
 - Item "Disk {$DISK_MONITOR3} write ops" использует параметр:

custom.disk.write.ops[{$DISK_MONITOR3}]
То есть каждый элемент данных использует свой макрос (переменную Zabbix), значение которого задается в настройках хоста или шаблона. Это обеспечивает удобную настройку мониторинга для нескольких дисков без изменения шаблона. Взаимодействие с триггерами (Triggers): Триггеры реагируют на значения, получаемые элементами данных, и генерируют проблемы (Problem events), когда значения превышают заданные пороги: Примеры:

1. Триггер "Высокое среднее время ожидания операций записи с диска": - Условие срабатывания (проблема возникает):

avg(/Custom Linux Monitoring/custom.disk.write.await[{$DISK_MONITOR2}],1)>=20
Это значит, что если в течение последней 1 минуты среднее время ожидания операций записи на диске (указанном в {$DISK_MONITOR2}) превышает 20 миллисекунд, триггер активируется и создает проблему. - Условие восстановления (проблема закрывается автоматически):

avg(/Custom Linux Monitoring/custom.disk.write.await[{$DISK_MONITOR2}],1)<=15
Если значение снизится ниже 15 миллисекунд, проблема будет автоматически закрыта.

2. Триггер "Высокое среднее время ожидания операций чтения с диска": - Условие срабатывания:

avg(/Custom Linux Monitoring/custom.disk.read.await[{$DISK_MONITOR}],1)>=15
Проблема активируется при среднем времени ожидания чтения более 15 миллисекунд за последнюю минуту. - Условие восстановления:

avg(/Custom Linux Monitoring/custom.disk.read.await[{$DISK_MONITOR}],1)<=10
Проблема автоматически закрывается при снижении значения ниже 10 миллисекунд. Итого схема взаимодействия следующая:


Таким образом, ваша схема мониторинга позволяет контролировать производительность дисковой подсистемы и оперативно реагировать на ухудшение характеристик ввода-вывода.
Инструкция и описание пользовательского параметра Zabbix для мониторинга состояния сетевого интерфейса через проверку флага LOWER_UP

1. Назначение пользовательского параметра (UserParameter): Пользовательский параметр служит для мониторинга текущего физического (или виртуального) состояния интерфейса Linux. Проверяется наличие специального флага LOWER_UP в выводе команды ip link. Именно флаг LOWER_UP говорит о том, что интерфейс не только поднят административно (UP), но и реально функционирует, пропускает трафик и подключен к сети (есть линк на физическом или виртуальном уровне). Cинтаксис UserParameter:

UserParameter=costom.net.ifstate[*], ip link show dev $1 | grep -q 'LOWER_UP' && echo 1 || echo 0
- `costom.net.ifstate[*]` — ключ параметра, по которому Zabbix получает значение состояния интерфейса.

- `$1` — передаётся в параметр имя интерфейса для мониторинга (например, eth0, ens33, wg0 и т.д.).

- Команда `ip link show dev $1 | grep -q 'LOWER_UP'` проверяет наличие флага LOWER_UP: - Если флаг есть, команда выводит значение `1` (UP). 

- Если флага нет, команда выводит значение `0` (DOWN). Таким образом, параметр возвращает:

- `1`— интерфейс находится в состоянии UP (активен и передает данные);

- `0` — интерфейс в состоянии DOWN (нет линка, не передает данные). 

2. Элемент данных (Item) в Zabbix: Создается элемент данных (Item), который регулярно (каждая 1 минута) обращается к агенту Zabbix и получает текущее состояние интерфейса:

 - Название элемента:  Network interface {$IFACE1} state
- Тип данных:  Numeric (unsigned)
- Ключ элемента (key):  custom.net.ifstate[{$IFACE1}]

Здесь используется макрос `{$IFACE1}`, который определяется на уровне шаблона или хоста и задаёт имя интерфейса для мониторинга. - Интервал опроса Zabbix агента:   1 минута

- Хранение данных:
- История: 31 день
- Тренды: 365 дней Описание элемента:

Мониторинг состояния интерфейса {$IFACE1} (1=UP, 0=DOWN)
Таким образом, элемент данных регулярно запрашивает состояние интерфейса агента Zabbix, используя пользовательский параметр, и сохраняет в базу данных значение 1 или 0. 3. Триггер (Trigger): Триггер отслеживает значение элемента данных и создает событие (проблему) в Zabbix, если интерфейс переходит в состояние DOWN (0):

- Название триггера:  Network interface {$IFACE1} down
- Выражение (Expression): 

last(/Custom Linux Monitoring/custom.net.ifstate[{$IFACE1}])<>1
Триггер срабатывает тогда, когда последнее полученное значение не равно 1, то есть интерфейс недоступен (DOWN).

- Операционные данные (Operational data):  Current state: {ITEM.LASTVALUE1}

При возникновении события Zabbix отображает текущее состояние интерфейса (0 или 1). Описание триггера:

Триггер срабатывает, если интерфейс Network interface {$IFACE1} на хосте переходит в состояние DOWN. Проверка состояния интерфейса происходит по наличию флага LOWER_UP (настроено через пользовательский параметр).
Схема взаимодействия выглядит так:


Эта схема позволяет оперативно реагировать на потерю связи на физическом или виртуальном уровне интерфейса, что позволяет вовремя обнаруживать сетевые проблемы и принимать меры для их устранения.

